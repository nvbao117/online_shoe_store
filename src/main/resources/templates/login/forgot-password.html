<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Forgot Password - Sneaker Shop</title>

    <!-- Bootstrap 5 CSS: dùng grid, form, button, v.v. -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <!-- Bootstrap Icons: dùng icon email, key, v.v. -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <!-- CSS chung cho tất cả trang auth (background video, overlay, layout) -->
    <link rel="stylesheet" th:href="@{/css/login/auth-layout.css}">
    <!-- CSS riêng cho trang Forgot Password -->
    <link rel="stylesheet" th:href="@{/css/login/forgot-password.css}">
</head>
<body>

<!-- ====================== VIDEO BACKGROUND (DÙNG CHUNG) ====================== -->
<div class="auth-bg-video-wrapper">
    <video class="auth-bg-video"
           id="authBgVideo"
           autoplay
           muted
           playsinline>
        Trình duyệt của bạn không hỗ trợ video.
    </video>
</div>

<!-- Lớp phủ mờ để form forgot nổi hơn trên video -->
<div class="auth-bg-overlay"></div>
<!-- ======================================================================== -->

<!--
    auth-page-wrapper: căn giữa nội dung (dùng chung cho login/register/forgot)
    auth-card: style card trắng bo góc + shadow (dùng chung)
    forgot-card: style riêng cho card forgot (độ rộng, spacing) nằm trong forgot-password.css
-->
<div class="auth-page-wrapper">

    <!-- Card trắng bo tròn giống login -->
    <div class="auth-card forgot-card">

        <!-- Logo -->
        <div class="forgot-logo text-center">
            <img th:src="@{/images/logo-shop/logo-sneaker.png}" alt="5A STORE Logo" class="forgot-logo-img">
        </div>

        <!-- Tiêu đề WELCOME, ATHLETE -->
        <h1 class="forgot-title text-center">WELCOME, ATHLETE</h1>

        <!-- Subtitle -->
        <p class="forgot-subtitle text-center">
            Sign in and step into your best performance
        </p>

        <!--
            FORM QUÊN MẬT KHẨU:
            - Email
            - New Password
            - Confirm New Password
            - OTP
        -->
        <form th:action="@{/forgot-password}" method="post" th:object="${forgotPasswordRequest}" class="mt-4" id="forgotPasswordForm">

            <div th:if="${errorMessage}" class="alert alert-danger text-start" role="alert" th:text="${errorMessage}"></div>
            <div id="otpMessage" class="alert text-start d-none" role="alert"></div>

            <!-- Ô Email -->
            <div class="mb-3">
                <div class="input-group">
                    <span class="input-group-text forgot-input-icon">
                        <i class="bi bi-envelope"></i>
                    </span>
                    <input type="email"
                           class="form-control forgot-input"
                           id="forgotEmail"
                           name="email"
                           th:value="*{email}"
                           placeholder="Email"
                           required>
                    <button type="button" class="btn forgot-otp-btn" id="btnSendOtp">
                        Gửi OTP
                    </button>
                </div>
                <small class="text-danger d-none" id="emailError"></small>
            </div>

            <!-- Ô New Password -->
            <div class="mb-3">
                <div class="input-group">
                    <span class="input-group-text forgot-input-icon">
                        <i class="bi bi-key"></i>
                    </span>
                    <input type="password"
                           class="form-control forgot-input"
                           id="newPassword"
                           name="newPassword"
                           placeholder="Mật khẩu mới (tối thiểu 8 ký tự, có chữ và số)"
                           required>
                </div>
                <small class="text-danger d-none" id="newPasswordError"></small>
            </div>

            <!-- Ô Confirm New Password -->
            <div class="mb-3">
                <div class="input-group">
                    <span class="input-group-text forgot-input-icon">
                        <i class="bi bi-key"></i>
                    </span>
                    <input type="password"
                           class="form-control forgot-input"
                           id="confirmNewPassword"
                           name="confirmNewPassword"
                           placeholder="Xác nhận mật khẩu mới"
                           required>
                </div>
                <small class="text-danger d-none" id="confirmPasswordError"></small>
            </div>

            <!-- Ô OTP -->
            <div class="mb-4">
                <div class="input-group">
                    <span class="input-group-text forgot-input-icon">
                        <i class="bi bi-file-earmark-text"></i>
                    </span>
                    <input type="text"
                           class="form-control forgot-input"
                           id="otpInput"
                           name="otp"
                           th:value="*{otp}"
                           placeholder="Nhập mã OTP (6 số)"
                           maxlength="6"
                           pattern="[0-9]{6}"
                           required>
                </div>
                <small class="text-danger d-none" id="otpError"></small>
            </div>

            <!-- Nút Submit -->
            <div class="d-grid">
                <button type="submit" class="btn forgot-submit-btn" id="btnSubmit">
                    Xác nhận đổi mật khẩu
                </button>
            </div>

        </form>
    </div> <!-- /auth-card forgot-card -->
</div> <!-- /auth-page-wrapper -->

<!-- Bootstrap JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- 1) Cấu hình danh sách video cho TRANG FORGOT PASSWORD -->
<script th:inline="javascript">
    // Có thể dùng chung playlist với login/register cho đồng bộ
    window.AUTH_VIDEO_SOURCES = [
        "/videos/basketball.mp4",
        "/videos/football.mp4",
        "/videos/badminton.mp4",
        "/videos/pingpong.mp4"
    ];
</script>

<!-- 2) JS dùng chung điều khiển video nền -->
<script th:src="@{/js/login/auth-bg.js}"></script>

<!-- 3) JS xử lý form forgot password -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const btnSendOtp = document.getElementById('btnSendOtp');
        const emailInput = document.getElementById('forgotEmail');
        const otpMessage = document.getElementById('otpMessage');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmNewPassword');
        const otpInput = document.getElementById('otpInput');
        const form = document.getElementById('forgotPasswordForm');
        
        let countdownInterval = null;
        let remainingSeconds = 0;

        if (!btnSendOtp || !emailInput || !otpMessage) return;

        // Hiển thị thông báo
        const showMessage = (message, isError = false) => {
            otpMessage.textContent = message;
            otpMessage.classList.remove('d-none', 'alert-info', 'alert-danger', 'alert-success');
            otpMessage.classList.add(isError ? 'alert-danger' : 'alert-info');
        };

        // Hiển thị lỗi validation
        const showError = (elementId, message) => {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.remove('d-none');
            }
        };

        const hideError = (elementId) => {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.classList.add('d-none');
            }
        };

        // Validation password
        const validatePassword = (password) => {
            if (!password || password.length < 8) {
                return 'Mật khẩu phải có ít nhất 8 ký tự';
            }
            if (!password.match(/.*[a-zA-Z].*/)) {
                return 'Mật khẩu phải chứa ít nhất một chữ cái';
            }
            if (!password.match(/.*[0-9].*/)) {
                return 'Mật khẩu phải chứa ít nhất một chữ số';
            }
            return null;
        };

        // Countdown timer
        const startCountdown = (seconds) => {
            remainingSeconds = seconds;
            btnSendOtp.disabled = true;
            
            const updateButton = () => {
                if (remainingSeconds > 0) {
                    btnSendOtp.textContent = `Gửi lại sau ${remainingSeconds}s`;
                    remainingSeconds--;
                } else {
                    btnSendOtp.disabled = false;
                    btnSendOtp.textContent = 'Gửi OTP';
                    if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                    }
                }
            };
            
            updateButton();
            countdownInterval = setInterval(updateButton, 1000);
        };

        // Gửi OTP
        btnSendOtp.addEventListener('click', function () {
            const email = emailInput.value.trim();
            hideError('emailError');

            if (!email) {
                showError('emailError', 'Vui lòng nhập email');
                showMessage('Vui lòng nhập email trước khi lấy OTP.', true);
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showError('emailError', 'Email không hợp lệ');
                showMessage('Email không hợp lệ.', true);
                return;
            }

            btnSendOtp.disabled = true;
            btnSendOtp.textContent = 'Đang gửi...';

            fetch('/forgot-password/send-otp?email=' + encodeURIComponent(email), {
                method: 'POST'
            })
                .then(resp => resp.text())
                .then(msg => {
                    const isError = msg.toLowerCase().includes('không') || 
                                   msg.toLowerCase().includes('lỗi') ||
                                   msg.toLowerCase().includes('đợi');
                    showMessage(msg, isError);
                    
                    if (!isError) {
                        // Thành công: bắt đầu countdown 60s
                        startCountdown(60);
                    } else {
                        // Lỗi: kiểm tra có phải rate limit không
                        if (msg.includes('đợi')) {
                            const match = msg.match(/(\d+)\s*giây/);
                            if (match) {
                                startCountdown(parseInt(match[1]));
                            } else {
                                startCountdown(60);
                            }
                        } else {
                            btnSendOtp.disabled = false;
                            btnSendOtp.textContent = 'Gửi OTP';
                        }
                    }
                })
                .catch(err => {
                    console.error(err);
                    showMessage('Không thể gửi OTP. Vui lòng thử lại.', true);
                    btnSendOtp.disabled = false;
                    btnSendOtp.textContent = 'Gửi OTP';
                });
        });

        // Validation real-time
        newPasswordInput.addEventListener('blur', function() {
            const password = this.value;
            hideError('newPasswordError');
            if (password) {
                const error = validatePassword(password);
                if (error) {
                    showError('newPasswordError', error);
                }
            }
        });

        confirmPasswordInput.addEventListener('blur', function() {
            const password = this.value;
            const newPassword = newPasswordInput.value;
            hideError('confirmPasswordError');
            if (password && newPassword && password !== newPassword) {
                showError('confirmPasswordError', 'Mật khẩu xác nhận không khớp');
            }
        });

        newPasswordInput.addEventListener('input', function() {
            const password = this.value;
            const confirmPassword = confirmPasswordInput.value;
            if (confirmPassword && password !== confirmPassword) {
                showError('confirmPasswordError', 'Mật khẩu xác nhận không khớp');
            } else {
                hideError('confirmPasswordError');
            }
        });

        // Validate OTP format
        otpInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            hideError('otpError');
        });

        // Form submission validation
        form.addEventListener('submit', function(e) {
            let hasError = false;
            
            // Clear previous errors
            hideError('emailError');
            hideError('newPasswordError');
            hideError('confirmPasswordError');
            hideError('otpError');

            const email = emailInput.value.trim();
            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            const otp = otpInput.value.trim();

            // Validate email
            if (!email) {
                showError('emailError', 'Email không được để trống');
                hasError = true;
            }

            // Validate password
            if (!newPassword) {
                showError('newPasswordError', 'Mật khẩu mới không được để trống');
                hasError = true;
            } else {
                const passwordError = validatePassword(newPassword);
                if (passwordError) {
                    showError('newPasswordError', passwordError);
                    hasError = true;
                }
            }

            // Validate confirm password
            if (!confirmPassword) {
                showError('confirmPasswordError', 'Vui lòng xác nhận mật khẩu');
                hasError = true;
            } else if (newPassword !== confirmPassword) {
                showError('confirmPasswordError', 'Mật khẩu xác nhận không khớp');
                hasError = true;
            }

            // Validate OTP
            if (!otp) {
                showError('otpError', 'Vui lòng nhập mã OTP');
                hasError = true;
            } else if (otp.length !== 6) {
                showError('otpError', 'Mã OTP phải có 6 chữ số');
                hasError = true;
            }

            if (hasError) {
                e.preventDefault();
                showMessage('Vui lòng kiểm tra lại thông tin đã nhập.', true);
            }
        });
    });
</script>

</body>
</html>
