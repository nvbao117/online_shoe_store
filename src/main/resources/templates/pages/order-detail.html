<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết đơn hàng | Shoe Store</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/checkout/css/checkout.css">
    <style>
        .container {
            max-width: 800px;
            margin-top: 40px;
            margin-bottom: 40px;
        }

        .section-card {
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 16px;
            border-bottom: 1px solid #F3F4F6;
            padding-bottom: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .info-label {
            color: #6B7280;
        }

        .info-value {
            font-weight: 500;
            color: #1F2937;
            text-align: right;
        }

        .item-row {
            display: flex;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid #F3F4F6;
        }

        .item-row:last-child {
            border-bottom: none;
        }

        .item-img {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #1F2937;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .item-meta {
            font-size: 12px;
            color: #6B7280;
        }

        .item-price {
            font-weight: 600;
            color: #1F2937;
            margin-left: auto;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="d-flex align-items-center mb-4">
            <a href="#" id="backBtn" class="btn btn-outline-secondary me-3"><i class="bi bi-arrow-left"></i> Quay
                lại</a>
            <h1 class="h3 mb-0">Chi tiết đơn hàng <span id="headerOrderId" class="text-primary"></span></h1>
        </div>

        <div id="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>

        <div id="orderContent" style="display: none;">
            <!-- Order Info -->
            <div class="section-card">
                <h5 class="section-title">Thông tin chung</h5>
                <div class="info-row">
                    <span class="info-label">Ngày đặt hàng</span>
                    <span class="info-value" id="orderDate">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Trạng thái</span>
                    <span class="info-value" id="orderStatus">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Phương thức thanh toán</span>
                    <span class="info-value" id="paymentMethod">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Trạng thái thanh toán</span>
                    <span class="info-value" id="paymentStatus">...</span>
                </div>
            </div>

            <!-- Address -->
            <div class="section-card">
                <h5 class="section-title">Địa chỉ nhận hàng</h5>
                <div class="info-row">
                    <span class="info-label">Người nhận</span>
                    <span class="info-value" id="recipientName">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Số điện thoại</span>
                    <span class="info-value" id="phone">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Địa chỉ</span>
                    <span class="info-value" id="address">...</span>
                </div>
            </div>

            <!-- Items -->
            <div class="section-card">
                <h5 class="section-title">Sản phẩm</h5>
                <div id="itemsContainer"></div>
            </div>

            <!-- Total -->
            <div class="section-card">
                <div class="info-row">
                    <span class="info-label">Tạm tính</span>
                    <span class="info-value" id="subtotal">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Phí vận chuyển</span>
                    <span class="info-value" id="shippingFee">...</span>
                </div>
                <div class="info-row" id="discountRow" style="display: none;">
                    <span class="info-label text-success">Giảm giá</span>
                    <span class="info-value text-success" id="discountAmount">...</span>
                </div>
                <div class="info-row mt-3 pt-3 border-top">
                    <span class="info-label fw-bold text-dark">Tổng cộng</span>
                    <span class="info-value fw-bold text-primary fs-5" id="totalAmount">...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Extract order ID from path /orders/{id}
            const pathParts = window.location.pathname.split('/');
            const orderId = pathParts[pathParts.length - 1];

            if (!orderId) {
                alert('Mã đơn hàng không hợp lệ');
                window.location.href = '/orders';
                return;
            }

            // Set back button to go to checkout success page
            document.getElementById('backBtn').href = `/checkout/success?orderId=${orderId}`;

            try {
                const response = await fetch(`/api/orders/${orderId}`);
                if (!response.ok) throw new Error('Failed to load order');
                const order = await response.json();

                const formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

                // Populate Data
                document.getElementById('headerOrderId').textContent = '#' + order.orderId.substring(0, 8);
                document.getElementById('orderDate').textContent = new Date(order.createdAt).toLocaleString('vi-VN');
                document.getElementById('orderStatus').textContent = translateStatus(order.status);
                document.getElementById('paymentMethod').textContent = order.paymentMethod;
                document.getElementById('paymentStatus').textContent = order.paymentStatus || 'Chưa thanh toán';

                document.getElementById('recipientName').textContent = order.customerName;
                document.getElementById('phone').textContent = order.phone;
                document.getElementById('address').textContent = order.shippingAddress;

                document.getElementById('subtotal').textContent = formatter.format(order.totalAmount);
                document.getElementById('shippingFee').textContent = formatter.format(order.shippingFee || 0);

                // Show discount if applicable
                const discountAmount = order.discountAmount || 0;
                if (discountAmount > 0) {
                    document.getElementById('discountRow').style.display = 'flex';
                    document.getElementById('discountAmount').textContent = '-' + formatter.format(discountAmount);
                }

                document.getElementById('totalAmount').textContent = formatter.format(order.finalAmount);

                // Items
                const itemsHtml = order.items.map(item => `
                <div class="item-row">
                    <img src="${item.imageUrl}" alt="${item.productName}" class="item-img">
                    <div class="item-details">
                        <div class="item-name">${item.productName}</div>
                        <div class="item-meta">Màu: ${item.color} | Size: ${item.size}</div>
                        <div class="item-meta">Số lượng: x${item.quantity}</div>
                    </div>
                    <div class="item-price">${formatter.format(item.totalPrice)}</div>
                </div>
            `).join('');
                document.getElementById('itemsContainer').innerHTML = itemsHtml;

                document.getElementById('loading').style.display = 'none';
                document.getElementById('orderContent').style.display = 'block';

            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerHTML = '<p class="text-danger">Không thể tải thông tin đơn hàng.</p>';
            }
        });

        function translateStatus(status) {
            const map = {
                'PENDING': 'Chờ xử lý',
                'COMPLETED': 'Hoàn thành',
                'CANCELLED': 'Đã hủy',
                'SHIPPING': 'Đang giao hàng',
                'DELIVERED': 'Đã giao'
            };
            return map[status] || status;
        }
    </script>
</body>

</html>